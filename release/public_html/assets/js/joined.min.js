/************************************************************
*															*
* www.pedrojhenriques.com v2.2.0							*
*															*
* Copyright 2017, PedroHenriques 							*
* http://www.pedrojhenriques.com 							*
* https://github.com/PedroHenriques 						*
*															*
* Free to use under the MIT license.			 			*
* http://www.opensource.org/licenses/mit-license.php 		*
*															*
************************************************************/"use strict";var TextBox=(function(){function TextBox(file_name){this.textbox_name="";this.textbox_elem=null;this.file_content="";this.building_style=false;this.style_text="";this.building_script=false;this.script_text="";this.dump_style=false;this.dump_script=false;this.write_by_line=false;this.speed=0;this.forced_speed=null;this.open_tags=[];this.cur_str="";this.str_to_render="";this.advance_chars=1;this.next_textbox="";this._expanded=true;this.textbox_name=file_name;this.textbox_elem=document.getElementById(file_name);}TextBox.setLang_=function(lang){TextBox.lang_=lang;};TextBox.setSpeeds_=function(speeds){for(var key in speeds){if(key in TextBox.speeds_){TextBox.speeds_[key]=speeds[key];}}};TextBox.prototype.setSpeed=function(speeds_index){if(speeds_index in TextBox.speeds_){this.speed=TextBox.speeds_[speeds_index];}};TextBox.prototype.setForcedSpeed=function(speeds_index){if(speeds_index in TextBox.speeds_){this.forced_speed=TextBox.speeds_[speeds_index];}};Object.defineProperty(TextBox.prototype,"expanded",{get:function(){return(this._expanded);},set:function(expanded){this._expanded=expanded;},enumerable:true,configurable:true});TextBox.prototype.run=function(){this.setSpeed("default");this.next_textbox="";if(this.textbox_elem==null){this.textbox_elem=TextBox.createTextBoxElem_(this.textbox_name);if(this.textbox_elem==null){return({"textbox":"","delay":this.speed});}}if(!this.renderContent()){return({"textbox":"","delay":this.speed});}this.determineSpeed();if(this.next_textbox!=""){return({"textbox":this.next_textbox,"delay":this.speed});}if(this.file_content==""){return({"textbox":"","delay":this.speed});}return({"textbox":this.textbox_name,"delay":this.speed});};TextBox.prototype.renderContent=function(){this.str_to_render="";var open_tags_length=this.open_tags.reduce(function(acc,val){return(acc+val);},0);this.advance_chars=0;if(this.write_by_line||TextBox.global_write_by_line_){var lb_index=-1;if((lb_index=this.file_content.search(TextBox.regex_["new_line"]))==-1){lb_index=this.file_content.length-1;}this.cur_str=this.file_content.substr(0,lb_index+1);}else{this.cur_str=this.file_content.substr(0,1);}if(!this.processTags()){return(false);}this.str_to_render+=this.cur_str;if(this.str_to_render!=""){if(this.textbox_elem==null||this.textbox_elem.lastElementChild==null){return(false);}if(!this.expanded){textboxExpandCollapse(this.textbox_name,true);}var render_elem=this.textbox_elem.lastElementChild;var new_text=render_elem.innerHTML.substr(0,render_elem.innerHTML.length-open_tags_length)+this.str_to_render;render_elem.innerHTML=new_text;render_elem.scrollTop=render_elem.scrollHeight;}if(!this.dumpTextBlock()){return(false);}this.file_content=this.file_content.substr(this.advance_chars);return(true);};TextBox.prototype.processTags=function(){var re_tag=null;var render_text=this.cur_str;if(!this.write_by_line&&!TextBox.global_write_by_line_){if(this.cur_str!="<"||(re_tag=this.file_content.match(TextBox.regex_["tag_content"]))==null||re_tag["index"]!=0){this.advance_chars=1;if(!this.processTextBlock(this.cur_str)){return(false);}return(true);}render_text=this.file_content.substr(0,re_tag[0].length);}this.cur_str="";var write_by_line=null;var building_script_off=false;var building_style_off=false;while((re_tag=render_text.match(TextBox.regex_["tag_content"]))!=null){if(re_tag["index"]==undefined){return(false);}building_script_off=false;building_style_off=false;var render_tag=false;if(re_tag[2]=="script"){if(re_tag[1]==""){this.building_script=true;if(re_tag[3].trim().toLowerCase()==TextBox.tag_keywords["byline"]){write_by_line=true;}}else{building_script_off=true;write_by_line=false;this.dump_script=true;}}else if(re_tag[2]=="style"){if(re_tag[1]==""){this.building_style=true;if(re_tag[3].trim().toLowerCase()==TextBox.tag_keywords["byline"]){write_by_line=true;}}else{building_style_off=true;write_by_line=false;this.dump_style=true;}}else if(re_tag[2]=="goto"){if(re_tag[3]==""){return(false);}this.next_textbox=re_tag[3].trim().toLowerCase();}else if(re_tag[2]=="speed"){if(re_tag[1]==""){if(re_tag[3]!=""){this.setForcedSpeed(re_tag[3]);}}else{this.forced_speed=null;}}else if(re_tag[2]=="byline"){if(re_tag[1]==""){write_by_line=true;}else{write_by_line=false;}}else if(re_tag[0].slice(-2)=="/>"||TextBox.self_closing_tags.indexOf(re_tag[2])!=-1){render_tag=true;}else{render_tag=true;if(re_tag[1]==""){if(re_tag[2]==""){return(false);}this.open_tags.push(re_tag[2].length+3);}else{this.open_tags.pop();}}var str_adjustment="";if(render_tag){str_adjustment=render_text.substr(0,re_tag["index"]+re_tag[0].length);this.advance_chars+=str_adjustment.length;}else{str_adjustment=render_text.substr(0,re_tag["index"]);this.advance_chars+=str_adjustment.length+re_tag[0].length;}this.cur_str+=str_adjustment;if(!this.processTextBlock(str_adjustment)){return(false);}if(building_script_off){this.building_script=false;}else if(building_style_off){this.building_style=false;}if(this.next_textbox==""){render_text=render_text.substr(re_tag["index"]+re_tag[0].length);}else{render_text="";}}this.cur_str+=render_text;this.advance_chars+=render_text.length;if(!this.processTextBlock(render_text)){return(false);}if(building_script_off){this.building_script=false;}else if(building_style_off){this.building_style=false;}if(write_by_line!=null){this.write_by_line=write_by_line;}return(true);};TextBox.prototype.processTextBlock=function(text){if(this.building_style){this.style_text+=text.replace(new RegExp(TextBox.re_str_tags_,"ig"),"");if(this.style_text.search(/\}\s?$/i)!=-1){this.dump_style=true;}}else if(this.building_script){this.script_text+=text.replace(new RegExp(TextBox.re_str_tags_,"ig"),"");}return(true);};TextBox.prototype.dumpTextBlock=function(){if(this.dump_style){TextBox.dom_style_tag_.innerHTML+=this.style_text;this.style_text="";this.dump_style=false;}if(this.dump_script){var new_script_tag=document.createElement("script");new_script_tag.innerHTML=this.script_text;document.body.appendChild(new_script_tag);this.script_text="";this.dump_script=false;}return(true);};TextBox.prototype.getFileContent=function(){var _this=this;return(new Promise(function(resolve,reject){var http_request;try{if(window.XMLHttpRequest){http_request=new XMLHttpRequest();}else{http_request=new ActiveXObject("MSXML2.XMLHTTP.3.0");}}catch(e){reject("The contents of the text box "+_this.textbox_name+" couldn't be retrieved.");}http_request.onload=function(){if(http_request.status===200){var file_text=http_request.responseText;if(file_text==""){reject("The contents of the text box "+_this.textbox_name+" couldn't be retrieved.");}file_text=file_text.replace(/(\n|\r\n)/g,"\r");file_text=TextBox.addScriptTags_(TextBox.addStyleTags_(file_text));_this.file_content=file_text;resolve("");}else{reject("The contents of the text box "+_this.textbox_name+" couldn't be retrieved.");}};http_request.open("GET","/ajax/read_file.php?fn="+_this.textbox_name+"&lang="+TextBox.lang_,true);http_request.send();}));};TextBox.prototype.determineSpeed=function(){if(TextBox.global_speed_!=null){this.speed=TextBox.global_speed_;return;}if(this.forced_speed!=null){this.speed=this.forced_speed;return;}if(this.building_style||this.building_script){var speeds_index="";speeds_index+=(this.building_style ? "style_by_":"script_by_");speeds_index+=(this.write_by_line ? "line":"char");this.speed=TextBox.speeds_[speeds_index];return;}if(this.write_by_line){this.speed=TextBox.speeds_["text_by_line"];return;}if(this.next_textbox!=""){return;}var test_str=this.cur_str.substr(-1)+this.file_content.substr(0,1);if(test_str.search(TextBox.regex_["short_pause"])!=-1){this.speed=TextBox.speeds_["short_pause"];}else if(test_str.search(TextBox.regex_["medium_pause"])!=-1){this.speed=TextBox.speeds_["medium_pause"];}else if(test_str.search(TextBox.regex_["long_pause"])!=-1){this.speed=TextBox.speeds_["long_pause"];}return;};TextBox.prototype.scrollToBottom=function(){if(this.textbox_elem==null){return;}var render_elem=this.textbox_elem.lastElementChild;if(render_elem==null){return;}render_elem.scrollTop=render_elem.scrollHeight;};TextBox.addStyleTags_=function(text){var tag_start=0;var tag_end=0;var final_text="";var temp_text="";while((tag_start=text.search(/\<style[^\<]*\>/i))!=-1){tag_start+=text.substr(tag_start,text.indexOf(">",tag_start)-tag_start).length+1;final_text+=text.substr(0,tag_start);tag_end=text.indexOf("</style>",tag_start);if(tag_end==-1){tag_end=text.length;}temp_text=text.substr(tag_start,tag_end-tag_start);temp_text=temp_text.replace(TextBox.regex_["css_keyword"],"<span class='css_keyword'>$1</span>(");temp_text=temp_text.replace(TextBox.regex_["css_selector"],"<span class='css_selector'>$1</span>$2");temp_text=temp_text.replace(/\{([^{}]+)<span class='css_selector'>([^{}]+)<\/span>([^{}]+)\}/ig,function(string){return(string.replace(/<span class='css_selector'\s*>([^\/]+)<\/span>/ig,"$1"));});temp_text=temp_text.replace(TextBox.regex_["css_property"],"$1<span class='css_property'>$2</span>$3");temp_text=temp_text.replace(TextBox.regex_["css_value"],":<span class='css_value'>$1</span>$2");temp_text=temp_text.replace(TextBox.regex_["css_value_units"],"$1<span class='css_units'>$2</span>");final_text+=temp_text+"</style>";text=text.slice(tag_end+"</style>".length);}final_text+=text;return(final_text);};TextBox.addScriptTags_=function(text){var tag_start=0;var tag_end=0;var final_text="";var temp_text="";while((tag_start=text.search(/\<script[^\<]*\>/i))!=-1){tag_start+=text.substr(tag_start,text.indexOf(">",tag_start)-tag_start).length+1;final_text+=text.substr(0,tag_start);tag_end=text.indexOf("</script>",tag_start);if(tag_end==-1){tag_end=text.length;}temp_text=text.substr(tag_start,tag_end-tag_start);temp_text=temp_text.replace(TextBox.regex_["js_logic_operator"],"<span class='js_logicoperator'>$1</span>");temp_text=temp_text.replace(TextBox.regex_["js_math_operator"],"$1<span class='js_mathoperator'>$2</span>");temp_text=temp_text.replace(TextBox.regex_["js_func_declaration"],"<span class='js_func_word'>$1</span><span class='js_func_name'>$2</span>(<span class='js_func_param'>$3</span>)$4");temp_text=temp_text.replace(TextBox.regex_["js_keyword"],"$1<span class='js_keyword'>$2</span>$3");temp_text=temp_text.replace(TextBox.regex_["js_object"],"<span class='js_object'>$1</span>");temp_text=temp_text.replace(TextBox.regex_["js_value"],"<span class='js_value'>$1</span>");temp_text=temp_text.replace(TextBox.regex_["js_method"],".<span class='js_method'>$1</span>");temp_text=temp_text.replace(/<span class='js_mathoperator'\s*>\/<\/span>([^\/]+)<span class='js_mathoperator'\s*>\/<\/span>([gmi]*)/ig,"/$1/$2");var regex_keys=["js_regexp","js_string"];var regex_strings=["$1<span class='js_regexp'>$2</span>","<span class='js_string'>$1</span>"];for(var i=0;i<regex_keys.length;i++){var regex_key=regex_keys[i];var str_aux="";var re_match=null;while((re_match=temp_text.match(TextBox.regex_[regex_key]))!=null){if(re_match.index==undefined){break;}str_aux+=temp_text.substr(0,re_match.index);str_aux+=temp_text.substr(re_match.index,re_match[0].length).replace(TextBox.regex_[regex_key],function(string){return(string.replace(/<span class='js_mathoperator'\s*>([<>]+)<\/span>/ig, "$1").replace(/<span\s+class='(css|js)_\w+'\s*>([^>]*)<\/span>/ig,"$2"));}).replace(TextBox.regex_[regex_key],regex_strings[i]);temp_text=temp_text.slice(re_match.index+re_match[0].length);}str_aux+=temp_text;temp_text=str_aux;}final_text+=temp_text+"</script>";text=text.slice(tag_end+"</script>".length);}final_text+=text;return(final_text);};TextBox.createTextBoxElem_=function(elem_id){if(TextBox.div_work_area_==null){return(null);}var new_div=document.createElement("div");new_div.id=elem_id;new_div.className="content flex_item";new_div.style.order=TextBox.textbox_elem_count.toString();var new_div_text=document.createElement("div");new_div_text.className="text text_expanded";new_div.appendChild(new_div_text);TextBox.div_work_area_.appendChild(new_div);if(typeof addHeaders=="function"){addHeaders(elem_id);}TextBox.textbox_elem_count++;return(document.getElementById(elem_id));};return TextBox;}());TextBox.div_work_area_=document.getElementById("work_area");TextBox.dom_style_tag_=document.body.getElementsByTagName("style")[0];TextBox.textbox_elem_count=0;TextBox.lang_="";TextBox.speeds_={default:0,style_by_char:0,script_by_char:0,style_by_line:0,script_by_line:0,text_by_line:0,short_pause:0,medium_pause:0,long_pause:0};TextBox.global_write_by_line_=false;TextBox.global_speed_=null;TextBox.tag_keywords={"byline":"byline"};TextBox.self_closing_tags=["br","hr","img"];TextBox.re_str_tags_="<(\\/?)([a-zA-Z0-9]+)\\s*([\\w\\/\\s=\\'\\\"\\.\\:\\-]*)>";TextBox.regex_={"short_pause":/^(,)/i,"medium_pause":/^(\.|!)/i,"long_pause":/^([\r\n]{2})/i,"tag_content":new RegExp(TextBox.re_str_tags_,"i"),"new_line":/[\r\n]/i,"css_keyword":/(@[\w\t ]+)\(/gi,"css_selector":/([\w\*\.\#\t: ]+)(\s?[\{,])/gi,"css_property":/([\{;\(]\s*)([\w-]+)(\s*:)/gi,"css_value":/:([^:;]*)([;)])/gi,"css_value_units":/(\d)(px|%|rem|em|vh|vw|s|ms)/gi,"js_func_declaration":/(function[\t ]+)(\w+[\t ]*)\(([^\)]*)\)([\t ]*\{)/gi,"js_keyword":/([\w])?(new|while|for|break|continue|try|catch|return|if|else|typeof)([^\w])/gi,"js_math_operator":/([^<])(\++|\-+|\*|\/)/gi,"js_logic_operator":/(&&|\|\||!=|={1,3}|<|>)/gi,"js_object":/(Object|var|let|document)/gi,"js_value":/(\d|true|false|null|undefined)/gi,"js_method":/\.(\w+)/gi,"js_string":/(\"[^\"]*\")/i,"js_regexp":/([^<>])(\/[^/]+\/[gmi]*)/i};var Engine=(function(){function Engine(lang,file_list,start_index,built_on_server){this.timeout_id=null;this.lang="";this.file_list=[];this.text_box_objs={};this.expanded_text_boxes={};this.active_box="";this.promises=[];this.active_speed_level=0;this.pending_speed_level=null;this.lang=lang;this.file_list=file_list;this.setDefaultSpeeds();TextBox.setLang_(this.lang);this.active_box=this.file_list[start_index];for(var i=0;i<this.file_list.length;i++){var file_name=this.file_list[i];this.text_box_objs[file_name]=new TextBox(file_name);this.expanded_text_boxes[file_name]=true;if(!built_on_server){this.promises.push(this.text_box_objs[file_name].getFileContent());}}}Engine.prototype.run=function(){var _this=this;Promise.all(this.promises).then(function(){_this.timeout_id=null;if(!(_this.active_box in _this.text_box_objs)){console.log("A call to the textbox \""+_this.active_box+"\" was made, but it doesn't exist.");return;}if(_this.pending_speed_level!=null){_this.changeSpeed(_this.pending_speed_level);}var return_value=_this.text_box_objs[_this.active_box].run();if(return_value["textbox"]===""){_this.finalTasks();return;}else{_this.active_box=return_value["textbox"];}if(!Engine.is_paused_){_this.timeout_id=window.setTimeout(function(){_this.run();},return_value["delay"]);}}).catch(function(message){console.log(message);});};Engine.prototype.setDefaultSpeeds=function(){TextBox.setSpeeds_({"default":20,"style_by_char":10,"script_by_char":10,"style_by_line":100,"script_by_line":100,"text_by_line":100,"short_pause":275,"medium_pause":550,"long_pause":750});};Engine.prototype.scrollBoxesToBottom=function(names){if(names===void 0){names=Object.keys(this.text_box_objs);}for(var i=0;i<names.length;i++){this.text_box_objs[names[i]].scrollToBottom();}};Engine.prototype.setTextboxState=function(name,expanded){if(!(name in this.text_box_objs)||!(name in this.expanded_text_boxes)){return;}if(!Engine.is_paused_){this.expanded_text_boxes[name]=expanded;}this.text_box_objs[name].expanded=expanded;};Engine.blockMouseEvents_=function(turn_on){if(Engine.div_work_area_==null){return;}var elem_classlist=Engine.div_work_area_.classList;if(turn_on){elem_classlist.add("no_events");}else{elem_classlist.remove("no_events");}};Engine.prototype.finalTasks=function(){var footer_elem=document.getElementById("footer_controls");if(footer_elem!=null){footer_elem.className+=" no_events opacity_zero";}Engine.blockMouseEvents_(false);};Engine.prototype.pauseProgram=function(){if(this.timeout_id!=null){window.clearTimeout(this.timeout_id);}Engine.is_paused_=true;var pause_button_elem=document.getElementById("pause_button");if(pause_button_elem!=null){pause_button_elem.classList.add("hidden");}var resume_button_elem=document.getElementById("resume_button");if(resume_button_elem!=null){resume_button_elem.classList.remove("hidden");}Engine.blockMouseEvents_(false);};Engine.prototype.resumeProgram=function(){var _this=this;var resume_delay=0;Engine.blockMouseEvents_(true);if(typeof textboxExpandCollapse=="function"){if(css_transition_dur_===null){getTransitionDuration();}for(var name_1 in this.text_box_objs){if(this.text_box_objs[name_1].expanded!=this.expanded_text_boxes[name_1]){textboxExpandCollapse(name_1,false);resume_delay=css_transition_dur_;}}}Engine.is_paused_=false;var resume_button_elem=document.getElementById("resume_button");if(resume_button_elem!=null){resume_button_elem.classList.add("hidden");}var pause_button_elem=document.getElementById("pause_button");if(pause_button_elem!=null){pause_button_elem.classList.remove("hidden");}window.setTimeout(function(){_this.run();},resume_delay);}; Engine.prototype.changeSpeed=function(speed_level){if(speed_level==this.active_speed_level){return;}switch(speed_level){case(0):this.setDefaultSpeeds();TextBox.global_write_by_line_=false;TextBox.global_speed_=null;break;case(1):TextBox.setSpeeds_({"short_pause":0,"medium_pause":0,"long_pause":0});TextBox.global_write_by_line_=false;TextBox.global_speed_=null;break;case(2):TextBox.global_write_by_line_=true;TextBox.global_speed_=0;break;}var speed_buttons=document.querySelectorAll("#footer_controls .speed");var button_classlist=speed_buttons[this.active_speed_level].classList;button_classlist.remove("selected");button_classlist.add("clickable");button_classlist=speed_buttons[speed_level].classList;button_classlist.remove("clickable");button_classlist.add("selected");this.active_speed_level=speed_level;this.pending_speed_level=null;};return Engine;}());Engine.is_paused_=false;Engine.div_work_area_=document.getElementById("work_area");var engine_obj_;var css_transition_dur_=null;var div_work_area_=document.getElementById("work_area");function init(built_on_server){ var file_list=["narrator_box","style_box","script_box","about_box"];var start_index=0;var lang="EN";var valid_langs=["PT","EN"]; var html_elem=document.getElementsByTagName("html")[0];if("lang" in html_elem){var tentative_lang=html_elem.lang.toUpperCase();if(valid_langs.indexOf(tentative_lang)!=-1){lang=tentative_lang;}}if(document.body.getElementsByTagName("style").length==0){document.body.appendChild(document.createElement("style"));}if(document.getElementById("work_area")==null){var div_elem=document.createElement("div");div_elem.id="work_area";div_elem.className="no_events";document.body.appendChild(div_elem);}engine_obj_=new Engine(lang,file_list,start_index,built_on_server);if(!built_on_server){engine_obj_.run();}}function getTransitionDuration(){css_transition_dur_=0;var dom_style_tag=document.body.getElementsByTagName("style")[0];if(dom_style_tag==null){return;}var re_string=/\*\s*\{[^\{\}]+transition\s*:[^\{\}\d]+([\d\.]+)(s|ms)[^\{\}]+\}/i;var re_match=null;if((re_match=dom_style_tag.innerHTML.match(re_string))!=null){css_transition_dur_=parseFloat(re_match[1])*(re_match[2]=="s" ? 1000:1);}}
